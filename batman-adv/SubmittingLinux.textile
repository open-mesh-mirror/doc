h1. Submitting Patches to Linux


We currently submit patches for Linux from our next branch. I try to give a short overview about it using some patches submitted to DaveM.

Following steps must always be done:
* get the linux-integration repository (we assume that the merge/master branch is up to date. The latest -rc1 must always be merged into merge/master, batman-adv/maint and batman-adv/next; The merge in batman-adv/maint and batman-adv/next must be a fast forward merge or somebody did something extremely wrong)
* get the newest patches from next
* merge pkg/next into merge/master
* check for compat code
* check difference with pkg/next
* rebase on top of previous version
* rebase on top of net-next/master
* squash/cleanup patches
* check if all versions compile cleanly using sparse (cgcc)
* format patches
* check commit messages author/signed-off-by of patches (Inform David about patches which have to send to stable@kernel.org by him)
* Add "batman-adv: " before each commit subject
* check if all patches are checkpatch.pl clean
* submit patches



h2. get the linux-integration repository


<pre>
'-(%25)-> git clone git+ssh://git@open-mesh.org/linux-merge.git
    Initialized empty Git repository in /home/batman/linux-merge/.git/
    remote: Counting objects: 1544059, done.
    remote: Compressing objects: 100%25 (252781/252781), done.
    ....
'-(%25)-> cd linux-merge
'-(%25)-> git remote add net-next git://git.kernel.org/pub/scm/linux/kernel/git/davem/net-next.git
'-(%25)-> git remote add pkg git://git.open-mesh.org/batman-adv.git
</pre>


h2. get the newest patches from next


<pre>
'-(%25)-(merge/master)> git remote update
    Fetching origin
    remote: Counting objects: 1387, done.
    remote: Compressing objects: 100%25 (211/211), done.
    remote: Total 823 (delta 651), reused 762 (delta 602)
    Receiving objects: 100%25 (823/823), 136.90 KiB | 254 KiB/s, done.
    Resolving deltas: 100%25 (651/651), completed with 228 local objects.
    From git+ssh://open-mesh.org/marek/linux-merge
       bfa88ea..151b6a5  pkg/master     -> origin/pkg/master
       c9f7cbe..078eb6a  pkg/next       -> origin/pkg/next
</pre>


h2. merge next into linux

<pre>
'-(%25)-(xyz)> git checkout merge/master
    Checking out files: 100%25 (32337/32337), done.
    Switched to branch 'merge/master'
'-(%25)-(merge/master)> git merge pkg/next
    Auto-merging net/batman-adv/Makefile
    CONFLICT (content): Merge conflict in net/batman-adv/Makefile
    CONFLICT (delete/modify): net/batman-adv/Makefile.kbuild deleted in HEAD and modified in pkg/next. Version pkg/next of net/batman-adv/Makefile.kbuild left in tree.
    CONFLICT (delete/modify): net/batman-adv/compat.h deleted in HEAD and modified in next. Version next of net/batman-adv/compat.h left in tree.
    Auto-merging net/batman-adv/main.c
    Auto-merging net/batman-adv/originator.c
    Auto-merging net/batman-adv/routing.c
    Auto-merging net/batman-adv/send.c
    Auto-merging net/batman-adv/soft-interface.c
    Auto-merging net/batman-adv/translation-table.c
    Auto-merging net/batman-adv/vis.c
    ...
    Automatic merge failed; fix conflicts and then commit the result.
'-(%25)-(merge/master)> git rm -rf CHANGELOG README.external compat.h compat-include/ gen-compat-autoconf.sh
    CHANGELOG: needs merge
    README.external: needs merge
    compat.h: needs merge
    rm 'CHANGELOG'
    rm 'README.external'
    ...
'-(%25)-(merge/master)> vim net/batman-adv/Makefile
'-(%25)-(merge/master)> git checkout merge/master Makefile README
'-(%25)-(merge/master)> git add net/batman-adv/Makefile
'-(%25)-(merge/master)> git commit
    [linux f2204f0] Merge remote branch 'pkg/next' into merge/master
</pre>

h2. check difference with next


<pre>
git diff pkg/next merge/master -- net/batman-adv/ Documentation/networking/batman-adv.txt Documentation/ABI/testing/sysfs-class-net-batman-adv Documentation/ABI/testing/sysfs-class-net-mesh
</pre>

h2. rebase on top of previous subtree merge/-rc1 merge 

<pre>
'-(%25)-(merge/master)> git checkout -b patches
'-(%25)-(patches)> git rebase origin/merge/master
    First, rewinding head to replay your work on top of it...
    Auto-merging net/batman-adv/main.c
    Auto-merging net/batman-adv/routing.c
    Auto-merging net/batman-adv/send.c
    Auto-merging net/batman-adv/soft-interface.c
    Auto-merging net/batman-adv/vis.c
    [detached HEAD 166b2ca] batman-adv: Convert names from Java to C style
     Author: Antonio Quartulli <ordex@ritirata.org>
     7 files changed, 18 insertions(+), 18 deletions(-)
    Committed: 0001 batman-adv: Convert names from Java to C style
    Auto-merging net/batman-adv/translation-table.c
    [detached HEAD 5cd6523] batman-adv: Avoid rounding issues for local hna timeout
     Author: Linus Lüssing <linus.luessing@web.de>
     1 files changed, 1 insertions(+), 1 deletions(-)
    Committed: 0002 batman-adv: Avoid rounding issues for local hna timeout
    Auto-merging net/batman-adv/originator.c
    Auto-merging net/batman-adv/translation-table.c
    Auto-merging net/batman-adv/vis.c
    [detached HEAD 83d1bc8] batman-adv: Lower resolution for timeouts
     Author: Simon Wunderlich <siwu@hrz.tu-chemnitz.de>
     5 files changed, 7 insertions(+), 10 deletions(-)
    Committed: 0003 batman-adv: Lower resolution for timeouts
    Auto-merging net/batman-adv/send.c
    [detached HEAD 9e9605f] batman-adv: replace manual calculation by msecs_to_jiffies() for better readability
     Author: Marek Lindner <lindner_marek@yahoo.de>
     1 files changed, 4 insertions(+), 4 deletions(-)
    Committed: 0004 batman-adv: replace manual calculation by msecs_to_jiffies() for better readability
    [detached HEAD 043aa9a] batman-adv: Add sysfs abi documentation about bonding
     Author: Marek Lindner <lindner_marek@yahoo.de>
     1 files changed, 8 insertions(+), 0 deletions(-)
    Committed: 0005 batman-adv: Add sysfs abi documentation about bonding
    [detached HEAD f6d8bab] batman-adv: adapting source version to revised versioning scheme
     Author: Marek Lindner <lindner_marek@yahoo.de>
     1 files changed, 1 insertions(+), 1 deletions(-)
    Committed: 0006 batman-adv: adapting source version to revised versioning scheme
    Auto-merging net/batman-adv/Makefile
    CONFLICT (content): Merge conflict in net/batman-adv/Makefile
    
    When you have resolved this problem run "git rebase --continue".
    If you would prefer to skip this patch, instead run "git rebase --skip".
    To restore the original branch and stop rebasing run "git rebase --abort".
'-(%25)-(f6d8baba5fce6161bc2cee9c97e0afbc139942c0)> vim net/batman-adv/Makefile
'-(%25)-(f6d8baba5fce6161bc2cee9c97e0afbc139942c0)> git add net/batman-adv/Makefile
'-(%25)-(f6d8baba5fce6161bc2cee9c97e0afbc139942c0)> git rebase --continue
    Already applied: 0007 batman-adv: Use nproc to get number of available processors
    CONFLICT (delete/modify): net/batman-adv/compat.h deleted in origin/merge/master and modified in HEAD~1. Version HEAD~1 of net/batman-adv/compat.h left in tree.
    
    When you have resolved this problem run "git rebase --continue".
    If you would prefer to skip this patch, instead run "git rebase --skip".
    To restore the original branch and stop rebasing run "git rebase --abort".
'-(%25)-(f6d8baba5fce6161bc2cee9c97e0afbc139942c0)> git rm net/batman-adv/compat.h
    net/batman-adv/compat.h: needs merge
    rm 'net/batman-adv/compat.h'
'-(%25)-(f6d8baba5fce6161bc2cee9c97e0afbc139942c0)> git rebase --continue
    [detached HEAD a85d1b4] batman-adv: Add include guards to all header files
     17 files changed, 78 insertions(+), 12 deletions(-)
    Committed: 0008 batman-adv: Add include guards to all header files
    Auto-merging net/batman-adv/Makefile
    CONFLICT (content): Merge conflict in net/batman-adv/Makefile
    CONFLICT (delete/modify): net/batman-adv/Makefile.kbuild deleted in origin/merge/master and modified in HEAD~0. Version HEAD~0 of net/batman-adv/Makefile.kbuild left in tree.
    
    When you have resolved this problem run "git rebase --continue".
    If you would prefer to skip this patch, instead run "git rebase --skip".
    To restore the original branch and stop rebasing run "git rebase --abort".
'-(%25)-(a85d1b45e4cde0c882a41baaefeec0cd5502416f)> git rm net/batman-adv/Makefile.kbuild
    net/batman-adv/Makefile: needs merge
    net/batman-adv/Makefile.kbuild: needs merge
    rm 'net/batman-adv/Makefile.kbuild'
'-(%25)-(a85d1b45e4cde0c882a41baaefeec0cd5502416f)> vim net/batman-adv/Makefile
'-(%25)-(a85d1b45e4cde0c882a41baaefeec0cd5502416f)> git add net/batman-adv/Makefile
'-(%25)-(a85d1b45e4cde0c882a41baaefeec0cd5502416f)> git rebase --continue
    Already applied: 0009 batman-adv: Add support for git revision string
    All done.
'-(%25)-(patches)> git diff merge/master
</pre>

The last diff must be empty or we did something wrong.


h2. squash/cleanup patches


<pre>
'-(%25)-(patches)> git rebase -i origin/merge/master
    Successfully rebased and updated refs/heads/patches
</pre>


h2. check if all patches compile cleanly against our linux tree with sparse (cgcc) 

We assume that the linux-merge tree was already build with @make allnoconfig@ and then enabling @CONFIG_NET=y@, @CONFIG_MODULES=y@, @CONFIG_LIBCRC32C=y@  and @CONFIG_CRC16=y@ (enable CONFIG_INET=y if you want to compile also DAT or BLA)

<pre>
'-(%25)-(patches)> git rev-list --reverse origin/merge/master..
    166b2caa61fce5260aed4e119671764331fdc62a
    5cd65234b12021fe1f28e28e455a6b6a06712ec2
    83d1bc8bb328bcfa42be492fe0e2648b77c18af2
    9e9605f0fe000f1097cb43271540ab2b76b2a782
    043aa9a54a5296c6027a5bcd808b8d29cea8a474
    f6d8baba5fce6161bc2cee9c97e0afbc139942c0
    a85d1b45e4cde0c882a41baaefeec0cd5502416f
'-(%25)-(patches)> cd net/batman-adv/
'-(%25)-(patches)> git checkout 166b2caa61fce5260aed4e119671764331fdc62a
    Previous HEAD position was a85d1b4... batman-adv: Avoid rounding issues for local hna timeout
    HEAD is now at 166b2ca... batman-adv: Convert names from Java to C style
'-(%25)-(166b2caa61fce5260aed4e119671764331fdc62a)> make CONFIG_BATMAN_ADV=m CC=cgcc -C ../../ M=`pwd`
...
'-(%25)-(166b2caa61fce5260aed4e119671764331fdc62a)> git checkout 5cd65234b12021fe1f28e28e455a6b6a06712ec2
    Previous HEAD position was 166b2ca... batman-adv: Convert names from Java to C style
    HEAD is now at 5cd6523... batman-adv: Avoid rounding issues for local hna timeout
'-(%25)-(83d1bc8bb328bcfa42be492fe0e2648b77c18af2)> make CONFIG_BATMAN_ADV=m CC=cgcc -C ../../ M=`pwd`
....
'-(%25)-(83d1bc8bb328bcfa42be492fe0e2648b77c18af2)> git checkout 9e9605f0fe000f1097cb43271540ab2b76b2a782
    Previous HEAD position was 83d1bc8... batman-adv: Lower resolution for timeouts
    HEAD is now at 9e9605f... batman-adv: replace manual calculation by msecs_to_jiffies() for better readability
'-(%25)-(9e9605f0fe000f1097cb43271540ab2b76b2a782)> make CONFIG_BATMAN_ADV=m CC=cgcc -C ../../ M=`pwd`
....
'-(%25)-(9e9605f0fe000f1097cb43271540ab2b76b2a782)> git checkout 043aa9a54a5296c6027a5bcd808b8d29cea8a474
    Previous HEAD position was 9e9605f... batman-adv: replace manual calculation by msecs_to_jiffies() for better readability
    HEAD is now at 043aa9a... batman-adv: Add sysfs abi documentation about bonding
'-(%25)-(043aa9a54a5296c6027a5bcd808b8d29cea8a474)> make CONFIG_BATMAN_ADV=m CC=cgcc -C ../../ M=`pwd`
...
'-(%25)-(043aa9a54a5296c6027a5bcd808b8d29cea8a474)> git checkout f6d8baba5fce6161bc2cee9c97e0afbc139942c0
    Previous HEAD position was 043aa9a... batman-adv: Add sysfs abi documentation about bonding
    HEAD is now at f6d8bab... batman-adv: adapting source version to revised versioning scheme
'-(%25)-(f6d8baba5fce6161bc2cee9c97e0afbc139942c0)> make CONFIG_BATMAN_ADV=m CC=cgcc -C ../../ M=`pwd`
...
'-(%25)-(f6d8baba5fce6161bc2cee9c97e0afbc139942c0)> git checkout a85d1b45e4cde0c882a41baaefeec0cd5502416f
    Previous HEAD position was f6d8bab... batman-adv: adapting source version to revised versioning scheme
    HEAD is now at a85d1b4... batman-adv: Add include guards to all header files
'-(%25)-(a85d1b45e4cde0c882a41baaefeec0cd5502416f)> make CONFIG_BATMAN_ADV=m CC=cgcc -C ../../ M=`pwd`
...
'-(%25)-(a85d1b45e4cde0c882a41baaefeec0cd5502416f)> git checkout patches
    Switched to branch 'patches'
'-(%25)-(patches)> cd ../../../
</pre>



h2. check if all patches build cleanly

It must be checked whether it builds with allnoconfig (@+NET@,@+CRC16@,@+LIBCRC32C=y,@+/-MODULES@,@+INET@) as module/builtin and allyesconfig as module/builtin

<pre>
'-(%25)-(patches)> make
....
</pre>

h2. format patches


<pre>
'-(%25)-(patches)> git format-patch --histogram -s -M origin/merge/master
    0001-batman-adv-Convert-names-from-Java-to-C-style.patch
    0002-batman-adv-Avoid-rounding-issues-for-local-hna-timeo.patch
    0003-batman-adv-Lower-resolution-for-timeouts.patch
    0004-batman-adv-replace-manual-calculation-by-msecs_to_ji.patch
    0005-batman-adv-Add-sysfs-abi-documentation-about.patch
    0006-batman-adv-adapting-source-version-to-revised-versio.patch
    0007-batman-adv-Add-include-guards-to-all-header-files.patch
'-(%25)-(patches)> vim 00*.patch
</pre>

Usually I add "batman-adv: " right when checking the signed-off-by and author (from) line. Patches which are also important bugfixes for older kernels (Kernel-Oops, Deadlock, ...) must also submitted to stable@kernel.org. It is done by adding  "Cc: stable@kernel.org" to this patch.


h2. checkpatch patches


<pre>
'-(%25)-(patches)> ./scripts/checkpatch.pl --strict 00*.patch
    total: 0 errors, 0 warnings, 0 checks, 135 lines checked
    
    0001-batman-adv-Convert-names-from-Java-to-C-styl.patch has no obvious style problems and is ready for submission.
    total: 0 errors, 0 warnings, 0 checks, 8 lines checked
    
    0002-batman-adv-Avoid-rounding-issues-for-local-h.patch has no obvious style problems and is ready for submission.
    total: 0 errors, 0 warnings, 0 checks, 55 lines checked
    
    0003-batman-adv-Lower-resolution-for-timeouts.patch has no obvious style problems and is ready for submission.
    total: 0 errors, 0 warnings, 0 checks, 19 lines checked
    
    0004-batman-adv-replace-manual-calculation-by-mse.patch has no obvious style problems and is ready for submission.
    total: 0 errors, 0 warnings, 0 checks, 14 lines checked
    
    0005-batman-adv-Add-sysfs-abi-documentation-about.patch has no obvious style problems and is ready for submission.
    total: 0 errors, 0 warnings, 0 checks, 8 lines checked
    
    0006-batman-adv-adapting-source-version-to-revise.patch has no obvious style problems and is ready for submission.
    total: 0 errors, 0 warnings, 0 checks, 239 lines checked
    
    0007-batman-adv-Add-include-guards-to-all-header-.patch has no obvious style problems and is ready for submission.
</pre>

h2. submit patches


<pre>
'-(%25)-(patches)> git checkout batman-adv/next
'-(%25)-(batman-adv/next)> git rev-parse batman-adv/next
    12513b76a021e5b41a9d5d5981da75dfd6480890
'-(%25)-(batman-adv/next)> git am -3 00*.patch
    Applying: batman-adv: Convert names from Java to C style
    Applying: batman-adv: Avoid rounding issues for local hna timeout
    Applying: batman-adv: Lower resolution for timeouts
    Applying: batman-adv: replace manual calculation by msecs_to_jiffies() for better readability
    Applying: batman-adv: Add sysfs abi documentation about bonding
    Applying: batman-adv: adapting source version to revised versioning scheme
    Applying: batman-adv: Add include guards to all header files
'-(%25)-(batman-adv/next)> git diff merge/master -- net/batman-adv/ Documentation/networking/batman-adv.txt Documentation/ABI/testing/sysfs-class-net-batman-adv Documentation/ABI/testing/sysfs-class-net-mesh
'-(%25)-(batman-adv/next)> git rebase net-next/master
    First, rewinding head to replay your work on top of it...
    Applying: batman-adv: Convert names from Java to C style
    Applying: batman-adv: Avoid rounding issues for local hna timeout
    Applying: batman-adv: Lower resolution for timeouts
    Applying: batman-adv: replace manual calculation by msecs_to_jiffies() for better readability
    Applying: batman-adv: Add sysfs abi documentation about bonding
    Applying: batman-adv: adapting source version to revised versioning scheme
    Applying: batman-adv: Add include guards to all header files
'-(%25)-(batman-adv/next)> git push -f origin batman-adv/next
'-(%25)-(batman-adv/next)> git push origin
'-(%25)-(batman-adv/next)> git tag -d batman-adv-for-davem
'-(%25)-(batman-adv/next)> git push origin :batman-adv-for-davem
'-(%25)-(batman-adv/next)> git tag -s batman-adv-for-davem
'-(%25)-(batman-adv/next)> git push origin batman-adv-for-davem
'-(%25)-(batman-adv/next)> git format-patch -s -M --histogram net-next/master..batman-adv-for-davem
'-(%25)-(batman-adv/next)> git request-pull net-next/master git://git.open-mesh.org/linux-merge.git batman-adv-for-davem > shortlog
'-(%25)-(batman-adv/next)> git send-email --compose --to=davem@davemloft.net --cc=netdev@vger.kernel.org --cc=b.a.t.m.a.n@lists.open-mesh.org 00*.patch
</pre>

Now I will write something like

<pre>
From Antonio Quartulli <antonio@meshcoding.com> # This line is ignored.
GIT: Lines beginning in "GIT:" will be removed.
GIT: Consider including an overall diffstat or table of contents
GIT: for the patch you are writing.
GIT:
GIT: Clear the body content if you don't wish to send a summary.
From: Antonio Quartulli <antonio@meshcoding.com>
Subject: pull request: batman-adv 2011-06-20
In-Reply-To:

Hello David,

this is a batch of patches intended for net-next.

In this patchset you have mostly cleanups and small corrections to issues
reported by checkpatch.

One notable change is the addition of the DEBUG_FS dependency to the
BATMAN_ADV_DEBUG symbol by Markus Pargmann. We add this dependency because all
the information provided by the DEBUG feature is accessible only through
debugfs.


Please pull or let me know of any problem!

Thanks a lot,
	Antonio



The following changes since commit 44d84d7272e5848878a96029b8a8b6e86854f146:

  Merge git://git.kernel.org/pub/scm/linux/kernel/git/davem/net (2015-01-06 22:29:20 -0500)

are available in the git repository at:

  git://git.open-mesh.org/linux-merge.git tags/batman-adv-for-davem

for you to fetch changes up to 9535395640edb23ba5cec2abb026c4ee51899722:

  batman-adv: Kconfig, Add missing DEBUG_FS dependency (2015-01-07 22:17:11 +0100)

----------------------------------------------------------------
Included changes:
- remove useless return in void functions
- remove unused member 'primary_iface' from 'struct orig_node'
- improve existing kernel doc
- fix several checkpatch complaints
- ensure socket's control block is cleared for received skbs
- add missing DEBUG_FS dependency to BATMAN_ADV_DEBUG symbol

----------------------------------------------------------------
Antonio Quartulli (7):
      batman-adv: avoid useless return in void functions
      batman-adv: checkpatch - else is not generally useful after a break or return
      batman-adv: checkpatch - No space is necessary after a cast
      batman-adv: checkpatch - Please use a blank line after declarations
      batman-adv: checkpatch - Please don't use multiple blank lines
      batman-adv: checkpatch - remove unnecessary parentheses
      batman-adv: fix misspelled words

Markus Pargmann (1):
      batman-adv: Kconfig, Add missing DEBUG_FS dependency

Martin Hundebøll (5):
      batman-adv: kernel doc fixes for bat_iv_ogm.c
      batman-adv: kernel doc fixes for bridge_loop_avoidance.c
      batman-adv: kernel doc fix for distributed-arp-table.h
      batman-adv: kernel doc fixes for main.{c, h}
      batman-adv: clear control block of received socket buffers

Simon Wunderlich (2):
      batman-adv: remove obsolete variable primary_iface from orig_node
      batman-adv: Start new development cycle

 net/batman-adv/Kconfig                 |  1 +
 net/batman-adv/bat_iv_ogm.c            | 15 +++++++--------
 net/batman-adv/bitarray.c              |  1 -
 net/batman-adv/bitarray.h              |  3 +--
 net/batman-adv/bridge_loop_avoidance.c | 17 +++++++----------
 net/batman-adv/debugfs.c               |  2 +-
 net/batman-adv/distributed-arp-table.c |  1 +
 net/batman-adv/distributed-arp-table.h |  4 +---
 net/batman-adv/fragmentation.c         |  1 -
 net/batman-adv/fragmentation.h         |  3 +--
 net/batman-adv/gateway_client.c        |  1 +
 net/batman-adv/main.c                  | 10 ++++++----
 net/batman-adv/main.h                  | 15 +++++++--------
 net/batman-adv/multicast.h             |  3 ---
 net/batman-adv/network-coding.c        |  3 +--
 net/batman-adv/originator.c            |  1 -
 net/batman-adv/originator.h            |  1 -
 net/batman-adv/packet.h                |  5 +++--
 net/batman-adv/routing.c               |  3 +--
 net/batman-adv/soft-interface.c        |  1 -
 net/batman-adv/sysfs.c                 |  1 -
 net/batman-adv/translation-table.c     |  8 +++-----
 net/batman-adv/types.h                 |  4 +---
 23 files changed, 43 insertions(+), 61 deletions(-)
</pre>